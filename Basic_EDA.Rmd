---
title: "Basic_EDA"
output: 
  html_document: 
    keep_md: yes
    toc: yes
    toc_float: yes
    toc_collapsed: yes
---

```{r setup, include=TRUE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(fig.width = 14, fig.height = 8)
 

source("functions.R")


set.seed(5678)
setwd('~/Analysis/16s-amplicon-processing/')



bact <- readRDS("bact.RData")
bact
fungi <- readRDS("fungi.RData")
fungi
```

## Save ASVs table at different levels

```{r}
bact %>% tax_table() %>% colnames()

write_ASVs_table(bact, "tables/ASVs_abs_abundances_bact.csv")
write_ASVs_table(bact, "tables/genus_abs_abundances_bact.csv", tax_level = "Genus")
write_ASVs_table(bact, "tables/Phylum_abs_abundances_bact.csv", tax_level = "Phylum")


write_ASVs_table(fungi %>% rarefy_even_depth(verbose = F), "tables/ASVs_raref_abundances_fungi.csv")
write_ASVs_table(fungi %>% rarefy_even_depth(verbose = F), "tables/genus_raref_abundances_fungi.csv", tax_level = "Genus")
write_ASVs_table(fungi %>% rarefy_even_depth(verbose = F), "tables/Phylum_raref_abundances_fungi.csv", tax_level = "Phylum")
```


## Plot barplots

```{r}
bargraph(ps = bact, rank = "Phylum", threshold = 0.05, percents = T) +
  facet_grid(cols = vars(Treatment, Dosage), scales = "free", space = "free")
# ggsave("bars.tiff", units="in", width=12, height=8, dpi=300, compression = 'lzw')


bargraph(ps = fungi, rank = "Class", threshold = 0.05, percents = T) +
  facet_grid(cols = vars(Treatment, Dosage), scales = "free", space = "free")
# ggsave("bars.tiff", units="in", width=12, height=8, dpi=300, compression = 'lzw')
```

## Heatmap

```{r fig.height=18}
plot_heatmap(ps = bact, X = "Filename", taxa = "Family", log.transform = T) + 
  facet_grid(rows = vars(Phylum), 
             cols = vars(Treatment, Dosage), scales = "free", space = "free")


plot_heatmap(ps = fungi, X = "Filename", taxa = "Family", log.transform = F) + 
  facet_grid(rows = vars(Phylum), 
             cols = vars(Treatment, Dosage), scales = "free", space = "free")
```

## Alpha-diversity

```{r}
sample_sums(bact)
alpha.bact <- alpha_div_table(ps = bact, 
                              cols_to_keep = c("Treatment", "Dosage"),
                              sample.size = 24, # can be NULL - rarefaction to the minimum
                              metric = c("Observed", "Shannon", "Simpson", "Chao1"))
alpha.bact %>% head() # also there are PD and MPD


sample_sums(fungi)
alpha.fungi <- alpha_div_table(ps = fungi, 
                              cols_to_keep = c("Treatment", "Dosage"))
alpha.fungi %>% head() # default indices
```

```{r}
plot_alpha(alpha_table = alpha.bact,
           X = "Treatment",
           colour = "Dosage")


plot_alpha(alpha_table = alpha.fungi,
           X = "Treatment",
           colour = "Dosage")
```


## Beta-diversity

```{r}
beta_plot(bact,
          method = "PCoA", distance = "bray", 
          color="Treatment", shape = "Dosage")

beta_plot(fungi,
          method = "PCoA", distance = "bray", 
          color="Treatment", shape = "Dosage")
```


## Relative abundance analysis

```{r}
full.bact <- readRDS("~/Soil_Institute/2025_Poultry/ps.16s.RData") %>%
  subset_samples(Group %in% c("Experiment") & (Treatment %in% c("Control", "Poultry_manure_single", "Poultry_manure_double")))
```


```{r message=FALSE, warning=FALSE}
deseq_sigtable(ps = full.bact, 
          formula = ~Treatment,
          baseMean = 20,
          log2FoldChange = 2)

deseq_sigtable(ps = full.bact, 
          formula = ~Treatment,
          baseMean = 20,
          log2FoldChange = 2,
          pairs = c("Control", "Poultry_manure_single"))

deseq_sigtable(ps = full.bact, 
          formula = ~Treatment,
          baseMean = 20,
          log2FoldChange = 2,
          pairs = c("Poultry_manure_single", "Poultry_manure_double"))
```

```{r message=FALSE, warning=FALSE}
ancombc_sigtable(ps = full.bact,
                 fix_formula = "Treatment")

ancombc_sigtable(ps = full.bact,
                 fix_formula = "Treatment",
                 intercept = "Control",
                 pairwise = T)

```

